<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>MC Ultra Merger & Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --accent-hover: #0ea5e9;
            --danger: #ef4444; --success: #22c55e; --text: #f8fafc; --warn: #f59e0b;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 1100px; background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        h1 { color: var(--accent); text-align: center; margin-bottom: 5px; }
        .toolbar { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; color: white; }
        .btn-blue { background: var(--accent); }
        .btn-orange { background: var(--warn); }
        .btn-green { background: var(--success); width: 100%; font-size: 1.1em; margin-top: 20px; }
        .item-list { display: flex; flex-direction: column; gap: 10px; }
        .item-row { 
            display: grid; grid-template-columns: 50px 1.5fr 1fr 80px 80px 100px auto; 
            gap: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; align-items: center;
        }
        .preview { width: 40px; height: 40px; object-fit: contain; image-rendering: pixelated; border: 1px solid #444; }
        input, select { background: #0f172a; border: 1px solid #334155; color: white; padding: 6px; border-radius: 4px; width: 100%; }
        label { font-size: 10px; color: #64748b; font-weight: bold; display: block; margin-bottom: 3px; }
        #log-area { margin-top: 20px; background: #000; padding: 15px; border-radius: 10px; display: none; border-left: 4px solid var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <h1>MC Ultra Merger 1.21.8</h1>
    <p style="text-align:center; color: #94a3b8">Dodawaj nowe ikony lub po≈ÇƒÖcz je z istniejƒÖcƒÖ paczkƒÖ .zip</p>

    <div class="toolbar">
        <button class="btn btn-blue" onclick="document.getElementById('img-upload').click()">+ DODAJ IKONY PNG</button>
        <button class="btn btn-orange" onclick="document.getElementById('zip-upload').click()">üìÇ PO≈ÅƒÑCZ Z ISTNIEJƒÑCYM ZIP</button>
        <input type="file" id="img-upload" multiple style="display:none" onchange="handleImages(this.files)">
        <input type="file" id="zip-upload" accept=".zip" style="display:none" onchange="handleZip(this.files[0])">
    </div>

    <div id="items-list" class="item-list"></div>

    <button class="btn btn-green" onclick="generateMegaPack()">GENERUJ PO≈ÅƒÑCZONƒÑ PACZKƒò</button>

    <div id="log-area">
        <h4 style="margin:0 0 10px 0">Status operacji:</h4>
        <div id="log-content" style="font-family: monospace; font-size: 13px; color: #38bdf8"></div>
    </div>
</div>

<canvas id="canvas" style="display:none"></canvas>

<script>
let items = [];
let baseZipFiles = {}; // Tu przechowamy pliki z wgranego ZIPa
let existingProviders = []; // Tu przechowamy istniejƒÖce ikony z default.json
let nextUnicode = 0xE001;

// Obs≈Çuga obrazk√≥w PNG
function handleImages(files) {
    for (let file of files) {
        const id = Math.random().toString(36).substr(2, 9);
        const reader = new FileReader();
        reader.onload = (e) => {
            items.push({
                id, file, preview: e.target.result, 
                alias: file.name.replace('.png',''),
                px: "16", height: 10, ascent: 9,
                hex: nextUnicode.toString(16).toUpperCase(),
                char: String.fromCharCode(nextUnicode)
            });
            nextUnicode++;
            render();
        };
        reader.readAsDataURL(file);
    }
}

// Obs≈Çuga importu ZIP
async function handleZip(file) {
    if(!file) return;
    const zip = await JSZip.loadAsync(file);
    baseZipFiles = zip.files;
    
    // Szukamy istniejƒÖcego default.json, ≈ºeby nie nadpisaƒá ikon innych os√≥b
    const fontPath = "assets/minecraft/font/default.json";
    if (zip.file(fontPath)) {
        const content = await zip.file(fontPath).async("string");
        try {
            const json = JSON.parse(content);
            existingProviders = json.providers || [];
            addLog(`Wczytano ${existingProviders.length} istniejƒÖcych dostawc√≥w czcionek.`);
        } catch(e) { addLog("B≈ÇƒÖd czytania default.json - plik mo≈ºe byƒá uszkodzony."); }
    }
    addLog("Paczka ZIP wczytana do pamiƒôci. Nowe ikony zostanƒÖ do niej dopisane.");
}

function render() {
    const container = document.getElementById('items-list');
    container.innerHTML = items.map(item => `
        <div class="item-row">
            <img src="${item.preview}" class="preview">
            <div><label>Nazwa</label><input type="text" value="${item.alias}" onchange="update('${item.id}', 'alias', this.value)"></div>
            <div><label>Rozmiar</label><select onchange="update('${item.id}', 'px', this.value)">
                <option value="16">16x16</option><option value="32">32x32</option><option value="64">64x64</option>
            </select></div>
            <div><label>Height</label><input type="number" value="${item.height}" onchange="update('${item.id}', 'height', this.value)"></div>
            <div><label>Ascent</label><input type="number" value="${item.ascent}" onchange="update('${item.id}', 'ascent', this.value)"></div>
            <div style="text-align:center"><label>Kod</label>\\u${item.hex}</div>
            <button class="btn" style="background:var(--danger)" onclick="remove('${item.id}')">‚úï</button>
        </div>
    `).join('');
}

function update(id, key, val) {
    let it = items.find(i => i.id === id);
    if(it) it[key] = (key === 'height' || key === 'ascent') ? parseInt(val) : val;
}

function remove(id) { items = items.filter(i => i.id !== id); render(); }

function addLog(msg) {
    document.getElementById('log-area').style.display = 'block';
    document.getElementById('log-content').innerHTML += "> " + msg + "<br>";
}

async function generateMegaPack() {
    const zip = new JSZip();
    
    // 1. Kopiujemy stare pliki (je≈õli by≈Çy)
    for (let path in baseZipFiles) {
        if (!baseZipFiles[path].dir) {
            const content = await baseZipFiles[path].async("blob");
            zip.file(path, content);
        }
    }

    // 2. Dodajemy nowe ikony
    const newProviders = [...existingProviders];
    for (let i = 0; i < items.length; i++) {
        const item = items[i];
        const fileName = `custom_icon_${Date.now()}_${i}.png`;
        const path = `assets/minecraft/textures/font/${fileName}`;
        
        // Render PNG
        const blob = await new Promise(res => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.getElementById('canvas');
                cvs.width = cvs.height = parseInt(item.px);
                const ctx = cvs.getContext('2d');
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                cvs.toBlob(res);
            };
            img.src = item.preview;
        });

        zip.file(path, blob);
        newProviders.push({
            "type": "bitmap",
            "file": `minecraft:font/${fileName}`,
            "ascent": item.ascent,
            "height": item.height,
            "chars": [item.char]
        });
        addLog(`Dodano: ${item.alias} -> \\u${item.hex}`);
    }

    // 3. Zapisujemy po≈ÇƒÖczony plik font√≥w
    zip.file("assets/minecraft/font/default.json", JSON.stringify({ providers: newProviders }, null, 4));
    
    // 4. Upewniamy siƒô, ≈ºe jest pack.mcmeta
    if (!zip.file("pack.mcmeta")) {
        zip.file("pack.mcmeta", JSON.stringify({ pack: { pack_format: 34, description: "Merged Ultra Pack" } }));
    }

    const final = await zip.generateAsync({type:"blob"});
    saveAs(final, "Merged_Minecraft_Pack.zip");
    addLog("Gotowe! Paczka zosta≈Ça pobrana.");
}
</script>
</body>
</html>
